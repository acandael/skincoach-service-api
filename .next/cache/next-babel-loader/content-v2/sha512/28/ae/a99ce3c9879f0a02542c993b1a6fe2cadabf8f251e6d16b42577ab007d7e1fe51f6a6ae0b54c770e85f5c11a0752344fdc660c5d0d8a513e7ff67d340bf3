{"ast":null,"code":"const crystallize = require(\"../../crystallize\");\n\nconst emailService = require(\"../../email-service\");\n\nconst basketService = require(\"../../basket-service\");\n\nconst toCrystallizeOrderModel = require(\"./to-crystallize-order-model\");\n\nmodule.exports = async function confirmOrder({\n  paymentIntentId,\n  checkoutModel,\n  context\n}) {\n  const {\n    basketModel\n  } = checkoutModel;\n  const {\n    user\n  } = context;\n  const basket = await basketService.get({\n    basketModel,\n    user\n  }); // Prepares a model valid for Crystallize order intake\n\n  const crystallizeOrderModel = await toCrystallizeOrderModel({\n    basket,\n    checkoutModel,\n    paymentIntentId\n  });\n  /**\n   * Record the order in Crystallize\n   * Manage the order lifecycle by using the fulfilment pipelines:\n   * https://crystallize.com/learn/user-guides/orders-and-fulfilment\n   */\n\n  const order = await crystallize.orders.createOrder(crystallizeOrderModel); // Wait for the order to be persisted\n\n  await crystallize.orders.waitForOrderToBePersistated({\n    id: order.id\n  });\n  /**\n   * Send out the order confirmation email to the customer\n   * It can also be done in a webhook, example here:\n   * - webhooks/order/created\n   */\n\n  await emailService.sendOrderConfirmation(order.id);\n  return {\n    success: true,\n    orderId: order.id\n  };\n};","map":{"version":3,"sources":["/Users/acandael/Sites/webshop-anniek/crystallize-app/src/services/payment-providers/stripe/confirm-order.js"],"names":["crystallize","require","emailService","basketService","toCrystallizeOrderModel","module","exports","confirmOrder","paymentIntentId","checkoutModel","context","basketModel","user","basket","get","crystallizeOrderModel","order","orders","createOrder","waitForOrderToBePersistated","id","sendOrderConfirmation","success","orderId"],"mappings":"AAAA,MAAMA,WAAW,GAAGC,OAAO,CAAC,mBAAD,CAA3B;;AACA,MAAMC,YAAY,GAAGD,OAAO,CAAC,qBAAD,CAA5B;;AACA,MAAME,aAAa,GAAGF,OAAO,CAAC,sBAAD,CAA7B;;AAEA,MAAMG,uBAAuB,GAAGH,OAAO,CAAC,8BAAD,CAAvC;;AAEAI,MAAM,CAACC,OAAP,GAAiB,eAAeC,YAAf,CAA4B;AAC3CC,EAAAA,eAD2C;AAE3CC,EAAAA,aAF2C;AAG3CC,EAAAA;AAH2C,CAA5B,EAId;AACD,QAAM;AAAEC,IAAAA;AAAF,MAAkBF,aAAxB;AACA,QAAM;AAAEG,IAAAA;AAAF,MAAWF,OAAjB;AAEA,QAAMG,MAAM,GAAG,MAAMV,aAAa,CAACW,GAAd,CAAkB;AAAEH,IAAAA,WAAF;AAAeC,IAAAA;AAAf,GAAlB,CAArB,CAJC,CAMD;;AACA,QAAMG,qBAAqB,GAAG,MAAMX,uBAAuB,CAAC;AAC1DS,IAAAA,MAD0D;AAE1DJ,IAAAA,aAF0D;AAG1DD,IAAAA;AAH0D,GAAD,CAA3D;AAMA;AACF;AACA;AACA;AACA;;AACE,QAAMQ,KAAK,GAAG,MAAMhB,WAAW,CAACiB,MAAZ,CAAmBC,WAAnB,CAA+BH,qBAA/B,CAApB,CAlBC,CAoBD;;AACA,QAAMf,WAAW,CAACiB,MAAZ,CAAmBE,2BAAnB,CAA+C;AAAEC,IAAAA,EAAE,EAAEJ,KAAK,CAACI;AAAZ,GAA/C,CAAN;AAEA;AACF;AACA;AACA;AACA;;AACE,QAAMlB,YAAY,CAACmB,qBAAb,CAAmCL,KAAK,CAACI,EAAzC,CAAN;AAEA,SAAO;AACLE,IAAAA,OAAO,EAAE,IADJ;AAELC,IAAAA,OAAO,EAAEP,KAAK,CAACI;AAFV,GAAP;AAID,CAtCD","sourcesContent":["const crystallize = require(\"../../crystallize\");\nconst emailService = require(\"../../email-service\");\nconst basketService = require(\"../../basket-service\");\n\nconst toCrystallizeOrderModel = require(\"./to-crystallize-order-model\");\n\nmodule.exports = async function confirmOrder({\n  paymentIntentId,\n  checkoutModel,\n  context,\n}) {\n  const { basketModel } = checkoutModel;\n  const { user } = context;\n\n  const basket = await basketService.get({ basketModel, user });\n\n  // Prepares a model valid for Crystallize order intake\n  const crystallizeOrderModel = await toCrystallizeOrderModel({\n    basket,\n    checkoutModel,\n    paymentIntentId,\n  });\n\n  /**\n   * Record the order in Crystallize\n   * Manage the order lifecycle by using the fulfilment pipelines:\n   * https://crystallize.com/learn/user-guides/orders-and-fulfilment\n   */\n  const order = await crystallize.orders.createOrder(crystallizeOrderModel);\n\n  // Wait for the order to be persisted\n  await crystallize.orders.waitForOrderToBePersistated({ id: order.id });\n\n  /**\n   * Send out the order confirmation email to the customer\n   * It can also be done in a webhook, example here:\n   * - webhooks/order/created\n   */\n  await emailService.sendOrderConfirmation(order.id);\n\n  return {\n    success: true,\n    orderId: order.id,\n  };\n};\n"]},"metadata":{},"sourceType":"script"}